https://microsoft.github.io/language-server-protocol/overviews/lsp/overview/
https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/

https://medium.com/@malintha1996/understanding-the-language-server-protocol-5c0ba3ac83d2


{
  "jsonrpc": "2.0",
  "id": 0,
  "method": "initialize",
  "params": {
    "processId": 1,
    "rootPath": "/home/kristian/docker-node-alpine-intelephense",
    "rootUri": "file:///home/kristian/docker-node-alpine-intelephense",
    "capabilities": {}
  }
}


Content-Length: 215
Content-Type: application/vscode-jsonrpc; charset=utf-8

{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":1,"rootPath":"/home","rootUri":"file:///home","capabilities":{}}}



sniffing/inspecting sublime-text's php intelephense

find PID of intelephense process in sublime
ps aux | grep -i intelephense

example output
/usr/bin/node /home/kristian/.cache/sublime-text/Package Storage/LSP-intelephense/22.7.0/language-server/node_modules/intelephense/lib/intelephense.js --stdio
from that output, communication mode is STDIO pipe (UNIX file descriptor)

therefore sniffing/inspecting requires reading STDIO pipe:
https://unix.stackexchange.com/a/58601

to see what syscall being made to write/read from STDIO pipe, we use this command:
strace -pPID -s9999 -e write/read
e.g.: assuming PID=8357:
strace -p8357 -s9999 -e read write

or with this 1 line:
strace -p`ps aux | grep intelephense | grep -v grep | tr -s ' ' | cut -d' ' -f2 | head -n1` -s9999 -e read write

example output:

read(0, "Content-Length: 265\r\n\r\n{\"jsonrpc\":\"2.0\",\"method\":\"textDocument/didOpen\",\"params\":{\"textDocument\":{\"uri\":\"file:///home/kristian/mnt/dev239/home/kristian/docker-node-alpine-intelephense/docker_volumes/home_kristian/test.php\",\"languageId\":\"php\",\"version\":0,\"text\":\"<?php echo myfunc($x);\"}}}", 65536) = 288

write(1, "{\"jsonrpc\":\"2.0\",\"method\":\"textDocument/publishDiagnostics\",\"params\":{\"uri\":\"file:///home/kristian/mnt/dev239/home/kristian/docker-node-alpine-intelephense/docker_volumes/home_kristian/test.php\",\"diagnostics\":[{\"range\":{\"start\":{\"line\":0,\"character\":11},\"end\":{\"line\":0,\"character\":17}},\"message\":\"Undefined function 'myfunc'.\",\"severity\":1,\"code\":\"P1010\",\"source\":\"intelephense\"}]}}", 383) = 383






coba inspect dengan redirect ke docker node:

menggunakan socat utk redirect socket ke stdio
contoh: ketik ini di terminal:
socat - tcp:example.com:80
GET / HTTP/1.1
Host: example.com
Content-Length: 0

akan mengeluarkan http response

lalu stdio dari node.js script diarahkan ke stdio dari socat tsb sebagai interactive shell, ref: https://stackoverflow.com/a/55044587

const { spawn } = require('child_process')
const shell = spawn('/tmp/socat-example.sh',[], { stdio: 'inherit' })
shell.on('close',(code)=>{console.log('[shell] terminated :',code)})

isi dari /tmp/socat-example.sh adalah:

#!/bin/bash
socat - tcp:example.com:80

failed!

attempt 2:
atau dengan langsung ke stdio:

stdio dari node.js script diarahkan ke stdio dari docker exec sebagai interactive shell

const { spawn } = require('child_process')
const shell = spawn('/tmp/record.sh',[], { stdio: 'inherit' })
shell.on('close',(code)=>{console.log('[shell] terminated :',code)})

isi dari record.sh adalah: ref: https://unix.stackexchange.com/a/394095

#!/bin/bash
script -q -c "docker exec -it intelephense intelephense --stdio" /tmp/stdout-result

failed!

attempt 3:

ubah intelephense.js berisi:
const { spawn } = require('child_process')
const shell = spawn('/tmp/record2.sh',[], { stdio: 'inherit' })
shell.on('close',(code)=>{console.log('[shell] terminated :',code)})

isi dari /tmp/record2.sh:

cat - | tee /tmp/hasil-tee-in | /usr/bin/node '/home/kristian/.cache/sublime-text/Package Storage/LSP-intelephense/22.7.0/language-server/node_modules/intelephense/lib/intelephense.js.real' --stdio 2>&1 | tee /tmp/hasil-tee-out

